---
layout:     post
title:      计算机图形学（三）——着色（Shading）
date:       2020-04-08
author:     XPX
header-img: img/post-bg-desk.jpg
catalog: true
tags:
    - 计算机图形学
---

### 画家算法

在将场景投影到平面之前，还需要处理物体之间的遮挡关系。比如下面这张图左边的景色，在屏幕中成像的顺序根据远近分别为雪山、草地、树木。而在正方体图形中，成像顺序是先成像最远的面，再成像周围四个面，最后是最近的面。对于周围的四个面也需要设置一定的顺序使视图符合物理规则。

<center>
    <img
    src="https://raw.githubusercontent.com/xjxpx/xjxpx.github.io/master/img/2020/04/shading-cover1.png">
</center>

但是对于下面这种摆放的物体，任何顺序都没有办法完全实现图中表述的位置关系。

<center>
    <img
    src="https://raw.githubusercontent.com/xjxpx/xjxpx.github.io/master/img/2020/04/shading-cover2.png">
</center>


### Z Buffer

在实际使用中，我们不会用画家算法渲染图像，而是使用Z Buffer方法。Z Buffer方法有几个特点：

- 对每个图像中的像素存储当前最小的z值
- 需要一个额外的buffer存储深度值（这也是Z Buffer名称的由来）
    - frame buffer
    - depth buffer (为了简明性，我们认为z永远是正的)

Z-Buffer 算法
```
for (each triangle T)
    for (each sample(x,y,z) in T)
        if (z < zbuffer[x,y])
            framebuffer[x,y] = rgb
            zbuffer[x,y] = z
```

复杂度： 对于n个三角形，计算复杂度为O（n）,但对于n个三角形的处理，可以使用多线程加快处理速度。

### 着色 （Shading）

着色表示对不同材料应用不同属性
根据材质和位置不同，反光区域分为
- 镜面高光区域（Specular highlights）
- 漫反射区域 （Diffuse reflection）
- 环境光区域 (Ambient lighting)
- 
#### 漫反射

漫反射的亮度和表面法向量和光源的夹角有关，夹角越小接受的能量越大，越明亮。
<center>
    <img
    src="https://raw.githubusercontent.com/xjxpx/xjxpx.github.io/master/img/2020/04/shading-diffuse_reflection.png">
</center>

此外表面亮度还和距离光源的远近有关，光强与距离的平方成反比。
<center>
    <img
    src="https://raw.githubusercontent.com/xjxpx/xjxpx.github.io/master/img/2020/04/shading-fall_off.png">
</center>

因此漫反射光的计算公式如下图，包括漫反射系数、不同距离的能量强度和反射面夹角这三个影响因素。**对于漫反射，观测的角度不会影响表面的亮度，因为漫反射表面会均匀地向四周发射光波**。
<center>
    <img
    src="https://raw.githubusercontent.com/xjxpx/xjxpx.github.io/master/img/2020/04/shading-diffuse_energy.png">
</center>

#### 镜面反射高光区域(Blinn-Phong)

在近似镜面的材质上，只有在反射光线很小的角度范围内才可以观察到。如下图所示，当观察角度与反射角度相近时，入射角度$\mathbf{n}$和观察角度$\mathbf{v}$的半程向量与平面的法向量很相近。其中半程向量表示的是观察角度与反射角度的**角平分线方向**的单位向量。

高光区域的表示公式如下，其中镜面反射系数为$k_s$，$max(0,\mathbf{n}\cdot \mathbf{h})$表示观察角度与入射角的夹角，指数$p$是为了使该项随角度的变化更加陡峭，实际中该指数项为100左右。
<center>
    <img
    src="https://raw.githubusercontent.com/xjxpx/xjxpx.github.io/master/img/2020/04/shading-mirror_reflection.png">
</center>

####  环境光照

在物体背向光源的区域仍然可以被观察到，这是因为环境光照的原因。环境光照与观测角度无关。

$$L_a=k_aI_a$$

#### 着色公式

综合三种反射模型，一个物体表面的着色公式可以表示为：

$$
\begin{aligned}
L &= L_a + L_d + L_s \\
  &=k_aI_a+k_d(I/r^2)max(0,\mathbf{n}\cdot\mathbf{l}) + k_s(I/r^2)max(0,\mathbf{n}\cdot\mathbf{h})
\end{aligned}$$

<center>
    <img
    src="https://raw.githubusercontent.com/xjxpx/xjxpx.github.io/master/img/2020/04/shading-shading.png">
</center>


### 着色频率
根据着色的方式不同，着色可以分为
1. 平面着色(Flat shading)：根据分割的平面区域分别着色，对于平滑的表面效果不好。
2. 顶点着色(Gouraud shading)：根据三角形的顶点计算着色数值，并在每个三角形内进行插值。
3. 像素点着色(Phong shading)：计算每个像素点对应的数值。

下图所示为三种不同的着色方式，最左边是平面着色，中间是顶点着色，右边是像素点着色。
<center>
    <img
    src="https://raw.githubusercontent.com/xjxpx/xjxpx.github.io/master/img/2020/04/shading-shading_frequence.png">
</center>

随着着色频率的提高，也就是采样的面、三角形、像素数量越多，三种方法的着色效果都会越来越好。
<center>
    <img
    src="https://raw.githubusercontent.com/xjxpx/xjxpx.github.io/master/img/2020/04/shading-shading_frequence1.png">
</center>

#### 顶点着色(Gouraud shading)中顶点法向量的计算
顶点的法向量是根据该顶点周围的平面法向量的加权得到的。如下图所示，点$v$的法向量是由周围4个平面的法向量加权得到的。
<center>
    <img
    src="https://raw.githubusercontent.com/xjxpx/xjxpx.github.io/master/img/2020/04/shading-gouraud_shading.png">
</center>

因此该点的法向量通过下面公式可以计算得到，该公式是最基本的计算方式。更加有效的方法是**根据三角形的面积大小对向量加权求和**。
$$N_v=\frac{\sum_iN_i}{\lVert \sum_iN_i\rVert}$$

#### 像素点着色(Phong shading)中顶点法向量的计算
像素点着色就是已知顶点的法向量，然后根据像素位置插值得到内部的法向量，如下图所示。该步骤会使用到重心插值方法（barycentric interpolation）。
<center>
    <img
    src="https://raw.githubusercontent.com/xjxpx/xjxpx.github.io/master/img/2020/04/shading-phong_shading.png">
</center>


### 实时渲染管线（Real-time Rendering Pipeline）

实时渲染步骤包括：
1. 将3D空间中的点投影到屏幕空间中->**Vertex Stream**
2. 将屏幕中的顶点连接成三角形->**Triangle Stream**
3. 将三角形内部的点光栅化为像素点->**Fragment Stream**
   1. 光栅化
   2. 深度测试（Z Buffer）
4. 将像素点着色->**Shaded fragments**
5. 将着色的三角形拼接成完整的图像->**Output image**

<center>
    <img
    src="https://raw.githubusercontent.com/xjxpx/xjxpx.github.io/master/img/2020/04/shading-pipeline.png">
</center>